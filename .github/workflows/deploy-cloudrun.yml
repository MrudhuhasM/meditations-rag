name: Deploy to Google Cloud Run

on:
  push:
    branches:
      - gcp-deployment

jobs:
  deploy:
    permissions:
      contents: read
      id-token: write

    runs-on: ubuntu-latest

    env:
      PROJECT_ID: meditations-rag-478911
      REGION: asia-south1
      REPO: meditations-rag-repo
      SERVICE: meditations-rag

    steps:
      - uses: actions/checkout@v4

      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: projects/180347172582/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: "cr-meditations-rag-deployer@meditations-rag-478911.iam.gserviceaccount.com"
        
      - name: Configure Docker
        run: gcloud auth configure-docker $REGION-docker.pkg.dev

      - name: Build Image
        run: |
          IMAGE="$REGION-docker.pkg.dev/$PROJECT_ID/$REPO/$SERVICE:$GITHUB_SHA"
          docker build -t "$IMAGE" .
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Push image
        run: docker push "$IMAGE"

      - name: Deploy to Cloud Run (private, cost-capped)
        run: |
          gcloud run deploy $SERVICE \
            --image "$IMAGE" \
            --region $REGION \
            --service-account "cr-meditations-rag-runtime@meditations-rag-478911.iam.gserviceaccount.com" \
            --no-allow-unauthenticated \
            --ingress internal-and-cloud-load-balancing \
            --min-instances 0 \
            --max-instances 2 \
            --concurrency 10 \
            --timeout 80 \
            --set-env-vars "RAG_LLM_PROVIDER=gemini,RAG_STRONG_LLM_PROVIDER=gemini,RAG_EMBEDDING_PROVIDER=gemini,RAG_BUFFER_SIZE=5,RAG_BREAK_POINT_THRESHOLD=95,RAG_CHUNK_EMBED_BATCH_SIZE=32,RAG_MAX_CONCURRENT_REQUESTS=5,RAG_FAILURE_THRESHOLD=0.2,RAG_BATCH_SIZE=32,RAG_EMBEDDING_DIMENSION=1024,RAG_EMBEDDING_API_BATCH_SIZE=32,RAG_METADATA_EXTRACTION_ENABLED=true,RAG_METADATA_BATCH_SIZE=10,RAG_METADATA_MAX_CONCURRENT=5,RAG_RETRIEVAL_TOP_K=6,RAG_RETRIEVAL_QUESTION_TOP_K=10,RAG_RETRIEVAL_ALPHA=0.3,RAG_RETRIEVAL_METADATA_TOP_K=5,RAG_RETRIEVAL_METADATA_ENABLED=true,RAG_RETRIEVAL_KEYWORD_BOOST=0.05,RAG_RETRIEVAL_TOPIC_BOOST=0.15,RAG_RETRIEVAL_CONCEPT_BOOST=0.10,RAG_RETRIEVAL_PRACTICE_BOOST=0.10,QDRANT_MAIN_COLLECTION_NAME=meditations,QDRANT_QUESTION_COLLECTION_NAME=meditations_questions,GEMINI_API_BASE=https://generativelanguage.googleapis.com/v1beta,GEMINI_LLM_MODEL_NAME=gemini-2.5-flash,GEMINI_STRONG_LLM_MODEL_NAME=gemini-2.5-pro,GEMINI_EMBEDDING_MODEL_NAME=gemini-embedding-001,GEMINI_TIMEOUT=60,GEMINI_MAX_RETRIES=3,GEMINI_TEMPERATURE=0.7,GEMINI_MAX_TOKENS=2048,GEMINI_REASONING_ENABLED=true,GEMINI_RATE_LIMIT_ENABLED=true,GEMINI_RATE_LIMIT_REQUESTS_PER_MINUTE=20,GEMINI_RATE_LIMIT_REQUESTS_PER_DAY=1500,APP_ENV=production,APP_DEBUG=False,LOGGING_LOG_LEVEL=INFO,APP_PORT=8080" \
            --set-secrets "APP_API_KEY=APP_API_KEY:latest,GEMINI_API_KEY=GEMINI_API_KEY:latest,QDRANT_API_KEY=QDRANT_API_KEY:latest,QDRANT_URL=QDRANT_URL:latest"

      